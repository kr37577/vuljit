# RQ3 脆弱性多重カウント修正計画

## 現状整理
- RQ3 シミュレーションは `RQ3/core/baseline.py:22` で脆弱性検出遅延をプロジェクト単位に中央値集約しており、1 プロジェクトにつき 1 つの閾値しか保持していない。
- `RQ3/core/simulation.py:162` 以降の `summarize_wasted_builds` ではプロジェクトごとに `detected_state` を更新しており、最初の検出成立後は以降のイベントを自動的に FP として扱ってしまう。
- `rq3_dataset/detection_time_results.csv` には 330 プロジェクトで 3,674 件の脆弱性が含まれているが、現行ロジックでは 1 プロジェクト 1 件しか検出済みとしてカウントされない。

## 修正ゴール
- [ ] プロジェクト内の複数脆弱性を順次追跡できるデータ構造に置き換え、各脆弱性について「追加ビルドで検出できたか／ベースラインで完了したか」を判定できる。
- [ ] 追加ビルド成功件数・浪費件数・検出ウィンドウ判定を脆弱性単位の結果に基づいて再集計できる。

## 作業項目

### 1. データモデルの拡張
- [✅] `detection_time_results.csv` から脆弱性 ID（`monorail_id` など）と検出遅延 `detection_time_days` を読み込み、1 レコード = 1 脆弱性の基準ビルド数を算出するユーティリティを追加する。
- [✅] 既存の `baseline_detection_metrics` を改修または新関数化し、脆弱性単位の基準ビルド数リスト（例：`List[DetectionTarget]`）を返すようにする。
- [✅] プロジェクト→脆弱性一覧のマッピングを生成し、シミュレーションで扱える形（Queue / Iterator）に変換する。

### 2. シミュレーションロジックの再設計
- [✅] `summarize_wasted_builds` を脆弱性単位の閾値リストと連携させ、各トリガーがどの脆弱性に対応して消費されたかを記録するようリファクタリングする。
- [✅] 複数脆弱性が同日に検出されるケースに備え、追加ビルド数の消費ロジック（`consumed_builds`）を 1 イベント内で複数ターゲットへ配分できるようにする。
- [✅] ベースライン進行・ウィンドウ減算処理を脆弱性ごとにリセットできるか確認し、検出済みターゲットを削除した後も次の脆弱性に対して累積計算が継続するよう調整する。
- [✅] イベントレコードに脆弱性 ID（または検出ターゲットの識別子）を追加し、どのターゲットを消費したか追跡できるようにする。

### 3. メトリクスと CLI の更新
- [✅] `summarize_wasted_builds` の戻り値スキーマを更新し、脆弱性単位の成功件数・浪費件数・ベースライン完了件数を正しく集計する。
- [✅] `prepare_project_metrics` / `aggregate_strategy_metrics` で新しいカラムに対応し、従来のプロジェクト単位集計が破綻しないよう確認する。
- [✅] `RQ3/cli/additional_builds_cli.py` の CSV 出力および表示ロジックを新スキーマに合わせて調整する。

### 4. テスト・検証
- [✅] 単体テストを追加し、1 プロジェクトに複数脆弱性が存在するシナリオで TP が複数回カウントされること、FP 判定が正しく残ることを確認する。
- [✅] 検出ウィンドウ有効時 / 無効時の双方で複数脆弱性が適切に期限切れ扱いされるか検証する。
- [✅] 既存テストを更新し、新しい出力カラム・イベントフィールドに対応させる。

### 5. ドキュメント・整備
- [ ] `additional_builds_sim_spec.md` などの技術ドキュメントに、脆弱性単位での検出ロジックへ変更した旨と新カラムの説明を追加する。
- [ ] アナリシス結果や再現手順（例：脆弱性数を確認するワンライナー）を `reports/` か適切なメモに追記し、再調査が容易になるよう残す。

### 6. テスト先行での準備
- [ ] `tests/test_core_simulation.py` に、1 プロジェクトで複数脆弱性を順番に検出できることを確認するテストケースを追加する（期待：最初のトリガーが 1 件目の `tp`、後続トリガーが 2 件目の `tp`）。
- [ ] 同一イベントで複数脆弱性閾値をまたぐケースを再現し、イベントログに対象脆弱性 ID 群が記録されることを検証するテストを用意する。
- [ ] ベースラインのみで 1 件検出後、追加ビルドが別の脆弱性に寄与するシナリオをテストし、`detections_baseline_only` と `detections_with_additional` が脆弱性単位で増加することを確認する。
- [ ] 検出ウィンドウ有効時に期限切れ扱いになる脆弱性を含むシナリオをテストへ追加し、実装時にウィンドウ挙動を回帰させないようガードする。

## 補足メモ
- 脆弱性件数は `python3 - <<'PY'` の簡易スクリプトで検証済み。環境に `pandas` が無い場合でも `csv.DictReader` でカウントできる。
- 既存の中央値ベースの閾値は後方互換性のため保持しつつ、脆弱性単位の閾値計算へ段階的に移行する方が安全。
